"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[19609],{45845:function(e,t,a){a.r(t),a.d(t,{assets:function(){return d},contentTitle:function(){return c},default:function(){return m},frontMatter:function(){return r},metadata:function(){return h},toc:function(){return u}});var n=a(83117),s=a(80102),i=(a(67294),a(3905)),o=a(13904),l=["components"],r={title:"Check API",tags:["API"]},c=void 0,h={unversionedId:"apis/subsystems/check/index",id:"apis/subsystems/check/index",title:"Check API",description:"A Check is a runtime test to make sure that something is working well. You can think of Checks as similar and complimentary to the PHPUnit and Acceptance testing but the next layer around them, and performed at run time rather than development, or build time.",source:"@site/docs/apis/subsystems/check/index.md",sourceDirName:"apis/subsystems/check",slug:"/apis/subsystems/check/",permalink:"/devdocs/docs/apis/subsystems/check/",draft:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/docs/apis/subsystems/check/index.md",tags:[{label:"API",permalink:"/devdocs/docs/tags/api"}],version:"current",lastUpdatedBy:"Andrew Lyons",lastUpdatedAt:1656028461,formattedLastUpdatedAt:"23/06/2022",frontMatter:{title:"Check API",tags:["API"]},sidebar:"docs",previous:{title:"Analytics API",permalink:"/devdocs/docs/apis/subsystems/analytics/"},next:{title:"Enrolment API",permalink:"/devdocs/docs/apis/subsystems/enrol"}},d={},u=[{value:"Result states of a check",id:"result-states-of-a-check",level:2},{value:"Check types and reports",id:"check-types-and-reports",level:2},{value:"Environmental checks",id:"environmental-checks",level:3},{value:"Configuration checks",id:"configuration-checks",level:3},{value:"Security checks (security)",id:"security-checks-security",level:3},{value:"Status checks (status)",id:"status-checks-status",level:3},{value:"Performance checks (performance)",id:"performance-checks-performance",level:3},{value:"Health checks (health)",id:"health-checks-health",level:3},{value:"Implementing a new check",id:"implementing-a-new-check",level:2},{value:"A check class",id:"a-check-class",level:3},{value:"The result summary",id:"the-result-summary",level:3},{value:"The details",id:"the-details",level:3},{value:"The action link",id:"the-action-link",level:3},{value:"lib.php callback",id:"libphp-callback",level:3},{value:"Multiple instances of checks",id:"multiple-instances-of-checks",level:3},{value:"Make checks as fast as practical",id:"make-checks-as-fast-as-practical",level:3},{value:"Lazy loading expensive result details",id:"lazy-loading-expensive-result-details",level:3},{value:"Asynchronous checks",id:"asynchronous-checks",level:3},{value:"See also",id:"see-also",level:2}],p={toc:u};function m(e){var t=e.components,a=(0,s.Z)(e,l);return(0,i.kt)("wrapper",(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)(o.Z,(0,n.Z)({frontMatter:r},void 0!==h?{metadata:h}:{},{mdxType:"MoodlePageBanner"})),(0,i.kt)("p",null,"A ",(0,i.kt)("em",{parentName:"p"},"Check")," is a runtime test to make sure that something is working well. You can think of Checks as similar and complimentary to the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.moodle.org/dev/PHPUnit"},"PHPUnit")," and ",(0,i.kt)("a",{parentName:"p",href:"https://docs.moodle.org/dev/Acceptance_testing"},"Acceptance testing")," but the next layer around them, and performed at run time rather than development, or build time."),(0,i.kt)("p",null,"Like other forms of testing the tests themselves should be easy to read, to reason about, and to confirm as valid."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Many types of runtime checks cannot be unit tested, and often the checks ",(0,i.kt)("strong",{parentName:"p"},"are")," the test."))),(0,i.kt)("p",null,"Checks can be used for a variety of purposes including:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"configuration checks"),(0,i.kt)("li",{parentName:"ul"},"security checks"),(0,i.kt)("li",{parentName:"ul"},"status checks"),(0,i.kt)("li",{parentName:"ul"},"performance checks"),(0,i.kt)("li",{parentName:"ul"},"health checks")),(0,i.kt)("p",null,"Moodle has had various types of checks and reports for a long time but they were inconsistent and not machine readable. In Moodle 3.9 they were unified under a single Check API which also enabled plugins to cleanly define their own additional checks. Some examples include:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"a password policy plugin could add a security check"),(0,i.kt)("li",{parentName:"ul"},"a custom authentication plugin can add a check that the upstream identity system can be connected to"),(0,i.kt)("li",{parentName:"ul"},"a MUC store plugin could add a performance check\nHaving these centralized and with a consistent contract makes it much easier to ensure the whole system is running smoothly. This makes it possible for an external integration with monitoring systems such as Nagios / Icinga. The Check API is expose as an NPRE compliance cli script:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-console"},"php admin/cli/checks.php\n")),(0,i.kt)("h2",{id:"result-states-of-a-check"},"Result states of a check"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Status"),(0,i.kt)("th",{parentName:"tr",align:null},"Meaning"),(0,i.kt)("th",{parentName:"tr",align:null},"Example"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"N/A"),(0,i.kt)("td",{parentName:"tr",align:null},"This check doesn't apply - but we may still want to expose the check"),(0,i.kt)("td",{parentName:"tr",align:null},"secure cookies setting is disabled because site is not https")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Ok"),(0,i.kt)("td",{parentName:"tr",align:null},"A component is configured, working and fast."),(0,i.kt)("td",{parentName:"tr",align:null},"ldap can bind and return value with low latency")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Info"),(0,i.kt)("td",{parentName:"tr",align:null},"A component is OK, and we may want to alert the admin to something non urgent such as a deprecation, or something which needs to be checked manually."),(0,i.kt)("td",{parentName:"tr",align:null})),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Unknown"),(0,i.kt)("td",{parentName:"tr",align:null},"We don't yet know the state. eg it may be very expensive so it is run using the Task API and we are waiting for the answer. NOTE: unknown is generally a bad thing and is semantically treated as an error. It is better to have a result of Unknown until the first result happens, and from then on it is Ok, or perhaps Warning or Error if the last known result is getting stale. If you are caching or showing a stale result you should expose the time of this in the result summary text."),(0,i.kt)("td",{parentName:"tr",align:null},"A complex user security report is still running for the first time.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Warning"),(0,i.kt)("td",{parentName:"tr",align:null},"Something is not ideal and should be addressed, eg usability or the speed of the site may be affected, but it may self heal (eg a load spike)"),(0,i.kt)("td",{parentName:"tr",align:null},"auth_ldap could bind but was slower than normal")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Error"),(0,i.kt)("td",{parentName:"tr",align:null},"Something is wrong with a component and a feature is not working"),(0,i.kt)("td",{parentName:"tr",align:null},"auth_ldap could not connect, so users cannot start new sessions")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Critical"),(0,i.kt)("td",{parentName:"tr",align:null},"An error which is affecting everyone in a major way"),(0,i.kt)("td",{parentName:"tr",align:null},"Cannot read site data or the database, the whole site is down")))),(0,i.kt)("p",null,"How the various states are then leveraged is a local decision. A typical policy might be that health checks with a status of 'Error' or 'Critical' will page a system administrator 24/7, while 'Warning' only pages during business hours."),(0,i.kt)("h2",{id:"check-types-and-reports"},"Check types and reports"),(0,i.kt)("p",null,"Checks are broken down into types, which roughly map to a step life cycle of your Moodle System"),(0,i.kt)("h3",{id:"environmental-checks"},"Environmental checks"),(0,i.kt)("p",null,"Available from ",(0,i.kt)("em",{parentName:"p"},"/admin/environment.php"),", environmental checks make sure that a Moodle instance is fully configured."),(0,i.kt)("p",null,"This page is a potential candidate to move to the new Check API but it slightly more complex than the other checks so hasn't been tackled yet. It would be a deeper change and this is intrinsically part of the install and upgrade system. It is not as critical to refactor as it is already possible for a plugin to declare its own checks, via either declarative ",(0,i.kt)("a",{parentName:"p",href:"https://docs.moodle.org/dev/Environment_checking"},"Environment checking")," or programmatically with a custom check:"),(0,i.kt)("h3",{id:"configuration-checks"},"Configuration checks"),(0,i.kt)("p",null,"Available from ",(0,i.kt)("em",{parentName:"p"},"/admin/index.php?cache=1"),", the Admin notifications page performs a mixture of checks, including security, status, and performance checks."),(0,i.kt)("p",null,"None of these checks are as exhaustive as the checks in the reports below. It also does additional checks including whether the web services for the Moodle Mobile App are enabled, and whether the site has been registered."),(0,i.kt)("h3",{id:"security-checks-security"},"Security checks (security)"),(0,i.kt)("p",null,"Available from ",(0,i.kt)("em",{parentName:"p"},"/report/security/index.php"),", these checks make sure that a Moodle instance is hardened correctly for you needs."),(0,i.kt)("p",null,"For more information see ",(0,i.kt)("a",{parentName:"p",href:"https://tracker.moodle.org/browse/MDL-67776"},"MDL-67776"),"."),(0,i.kt)("h3",{id:"status-checks-status"},"Status checks (status)"),(0,i.kt)("p",null,"Available from ",(0,i.kt)("em",{parentName:"p"},"/report/status/index.php"),", a status check is an 'in the moment' test and covers operational tests such as 'can moodle connect to ldap'. The main core status checks are that cron is running regularly and there has been no failed tasks."),(0,i.kt)("div",{className:"admonition admonition-danger alert alert--danger"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"Important")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"It is critical to understand that Status checks are conceptually defined at the level off the application and not at a lower host level such as a docker container or node in a cluster. Checks should be defined so that whichever instance you ask you should get a consistent answer. DO NOT use the Status Checks to detect containers which need reaped and restarted. If you do, any status error will mean all containers will simultaneously be marked for reaping."),(0,i.kt)("p",{parentName:"div"},"An additional status check is likely the most common type of check a plugin would define. Especially a plugin that connects to a 3rd party service. If the concept of 'OK' requires some sort of threshold, eg network response within 500ms, then that threshold should be managed by the plugin and optionally exposed as a admin setting. The plugin may choose to have different thresholds for Warning / Error / Critical. When designing a new Status Check be mindful that it needs to be actionable, for instance if you are asserting that a remote domain is available and it goes down, which then alerts your infrastructure team, there isn't much they can do about it if it isn't their domain. If it is borderline then make things like this configurable so that each site has to option of tune their own policies of what should be considered an issue or not."))),(0,i.kt)("p",null,"For more information see ",(0,i.kt)("a",{parentName:"p",href:"https://tracker.moodle.org/browse/MDL-47271"},"MDL-47271"),"."),(0,i.kt)("h3",{id:"performance-checks-performance"},"Performance checks (performance)"),(0,i.kt)("p",null,"Available from ",(0,i.kt)("em",{parentName:"p"},"/report/performance/index.php"),", each check might simply check for certain settings which are known to slow things down, or it might actually do some sort of test like multiple reads and writes to the db or filesystem to get a performance metric."),(0,i.kt)("h3",{id:"health-checks-health"},"Health checks (health)"),(0,i.kt)("p",null,"Available from ",(0,i.kt)("em",{parentName:"p"},"/admin/tool/health"),", the 'health center' is currently unsupported and contains some very old code. It is conceptually similar to 'status' checks except larger more long terms issues, such as detecting corrupt records. Ideally it is improved and converted to the Check API, see ",(0,i.kt)("a",{parentName:"p",href:"https://tracker.moodle.org/browse/%5BMDL-67228%5D(https://tracker.moodle.org/browse/MDL-67228)"},"https://tracker.moodle.org/browse/[MDL-67228](https://tracker.moodle.org/browse/MDL-67228)")),(0,i.kt)("h2",{id:"implementing-a-new-check"},"Implementing a new check"),(0,i.kt)("h3",{id:"a-check-class"},"A check class"),(0,i.kt)("p",null,"And make a new check class in ",(0,i.kt)("inlineCode",{parentName:"p"},"mod/myplugin/classes/check/foobar.php")," and the only mandatory method is ",(0,i.kt)("inlineCode",{parentName:"p"},"get_result()"),". By default it will use a set language string but you can override the ",(0,i.kt)("inlineCode",{parentName:"p"},"get_name()")," method to reuse an existing string."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/myplugin/lang/en/myplugin.php"',title:'"mod/myplugin/lang/en/myplugin.php"'},"$string['checkfoobar'] = 'Check the foos to make sure they are barred';\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/myplugin/classes/check/foobar"',title:'"mod/myplugin/classes/check/foobar"'},"<?php\nnamespace mod_myplugin\\check;\nuse core\\check\\check;\n\nclass foobar extends check {\n\n    public function get_action_link(): ?\\action_link {\n        $url = new \\moodle_url('/mod/myplugin/dosomething.php'),\n        return new \\action_link($url, get_string('sitepolicies', 'admin'));\n    }\n\n    public function get_result(): result {\n        if (some_check()) {\n            $status = result::ERROR;\n            $summary = get_string('check_foobar_error', 'mod_myplugin');\n        } else {\n            $status = result::OK;\n            $summary = get_string('check_foobar_ok', 'mod_myplugin');\n        }\n        $details = get_string('check_details', 'mod_myplugin');\n        return new result($status, $summary, $details);\n    }\n}\n")),(0,i.kt)("h3",{id:"the-result-summary"},"The result summary"),(0,i.kt)("p",null,"The summary could change depending on the result of the check but for a simple check might be a fixed string, not html. Try to keep the summary to 1 line as this might typically be the thing which gets passed through to a paging system and could be truncated."),(0,i.kt)("h3",{id:"the-details"},"The details"),(0,i.kt)("p",null,"Unlike the summary the details is allowed and encouraged to be html. Often it will be a bullet list of a table of the things that it asserted which make up the check."),(0,i.kt)("h3",{id:"the-action-link"},"The action link"),(0,i.kt)("p",null,"The action link is the place to go to help fix the issue. It should be as specific as possibly, such as a deep link into an admin settings page, and can include hash anchors."),(0,i.kt)("h3",{id:"libphp-callback"},"lib.php callback"),(0,i.kt)("p",null,"First decide if and when your new check(s) should be shown. Should it be present if your plugin is disabled? If you do not want it show if disabled then do not return it in callback below. If you do want it to show when disabled, but the check doesn't much sense then you can return a value of NA."),(0,i.kt)("p",null,"Next decide on what type of check it should be which determines what report it will be included in. Some checks might make sense to be reused with more than one report, eg it could be in both Status and Performance."),(0,i.kt)("p",null,"Implement the right callback in lib.php for the report you want to add it to, and return an array (usually with only 1 item) of check objects:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="/mod/myplugin/lib.php"',title:'"/mod/myplugin/lib.php"'},"function mod_myplugin_security_checks(): array {\n    return [new \\mod_myplugin\\check\\foobar()];\n}\n")),(0,i.kt)("h3",{id:"multiple-instances-of-checks"},"Multiple instances of checks"),(0,i.kt)("p",null,"Checks have been designed to be dynamic so you can return different checks depending on configuration, so auth_ldap would not return a check if the plugin is not enabled. Hypothetically if auth_ldap could be configured with 5 ldap servers then you could return 5 independent checks for each remote connection, each with different labels and information."),(0,i.kt)("p",null,"If you plan to return multiple instances of a check class, make sure that each instance has a unique id."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"function mod_myplugin_security_checks(): array {\n    return [\n        new \\mod_myplugin\\check\\foobar('one'),\n        new \\mod_myplugin\\check\\foobar('two'),\n    ];\n}\n")),(0,i.kt)("p",null,"Set the internal id in a way which is unique across all instances in your components namespace:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"namespace mod_myplugin\\check;\n\nclass foobar extends \\core\\check\\check {\n    protected $id = '';\n\n    public function __construct($id) {\n        $this->id = \"foobar{$id}\";\n    }\n\n    public function get_id(): string {\n        return $this->id;\n    }\n    ...\n}\n")),(0,i.kt)("h3",{id:"make-checks-as-fast-as-practical"},"Make checks as fast as practical"),(0,i.kt)("p",null,"As many checks will be run and compiled into a report we want the checks themselves to be simple and as fast as possible. For instance an auth_ldap check while authenticating an end user could have a timeout of 60 seconds, and the check could warn if it takes more than 2 seconds. But the check could have a hard timeout of say 5 seconds and have a result status of ERROR for 5 or more seconds."),(0,i.kt)("h3",{id:"lazy-loading-expensive-result-details"},"Lazy loading expensive result details"),(0,i.kt)("p",null,"Checks can provide details on a check, such as the complete list of bad records. Generally this type of information might be expensive to produce so you can defer this lookup until get_details() is called specifically rather than setting this in the constructor. It will only be loaded on demand and shown when you drill down into the check details page."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"<?php\n\nnamespace mod_myplugin\\check;\n\nclass foobar extends \\core\\check\\check {\n    public function get_result(): result {\n        return new foobar_result();\n    }\n}\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"class foobar_result extends \\core\\check\\result {\n    ...\n    public function get_details(): string {\n        // Do expensive lookups in here.\n    }\n}\n")),(0,i.kt)("p",null,"For a real example see:"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://github.com/moodle/moodle/blob/master/lib/classes/check/access/riskxss_result.php"},"https://github.com/moodle/moodle/blob/master/lib/classes/check/access/riskxss_result.php")),(0,i.kt)("h3",{id:"asynchronous-checks"},"Asynchronous checks"),(0,i.kt)("p",null,"Some checks are by their nature asynchronous. For instance having moodle send an email to itself and then having it processed by the inbound mail handler to make it's properly configured (see ",(0,i.kt)("a",{parentName:"p",href:"https://tracker.moodle.org/browse/MDL-48800"},"MDL-48800"),"). In cases like these please make sure the age or staleness of the check is shown in the summary, and you should also consider turning the result status into a warning if the result is too old. If appropriate make the threshold a configurable admin setting."),(0,i.kt)("h2",{id:"see-also"},"See also"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://docs.moodle.org/en/Performance_overview"},"Performance overview")," user docs")))}m.isMDXComponent=!0}}]);