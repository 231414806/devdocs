"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[19791],{15966:function(e,t,n){n.r(t),n.d(t,{assets:function(){return d},contentTitle:function(){return p},default:function(){return m},frontMatter:function(){return l},metadata:function(){return u},toc:function(){return c}});var a=n(83117),i=n(80102),s=(n(67294),n(3905)),o=n(13904),r=["components"],l={title:"Privacy API",tags:["Privacy","GDPR","API"]},p=void 0,u={unversionedId:"apis/subsystems/privacy/index",id:"apis/subsystems/privacy/index",title:"Privacy API",description:"The General Data Protection Regulation (GDPR) is an EU directive that provides users with more control over their data and how it is processed. This regulation came into effect on 25th of May 2018 and covers any citizen or permanent resident of the European Union. The directive is respected by a number of other countries outside of the European Union.",source:"@site/docs/apis/subsystems/privacy/index.md",sourceDirName:"apis/subsystems/privacy",slug:"/apis/subsystems/privacy/",permalink:"/devdocs/docs/apis/subsystems/privacy/",draft:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/docs/apis/subsystems/privacy/index.md",tags:[{label:"Privacy",permalink:"/devdocs/docs/tags/privacy"},{label:"GDPR",permalink:"/devdocs/docs/tags/gdpr"},{label:"API",permalink:"/devdocs/docs/tags/api"}],version:"current",lastUpdatedBy:"Andrew Lyons",lastUpdatedAt:1656028418,formattedLastUpdatedAt:"23/06/2022",frontMatter:{title:"Privacy API",tags:["Privacy","GDPR","API"]},sidebar:"docs",previous:{title:"Plagiarism API",permalink:"/devdocs/docs/apis/subsystems/plagiarism"},next:{title:"FAQs",permalink:"/devdocs/docs/apis/subsystems/privacy/faq"}},d={},c=[{value:"Personal data in Moodle",id:"personal-data-in-moodle",level:2},{value:"Background",id:"background",level:2},{value:"Architecture overview",id:"architecture-overview",level:3},{value:"Implementing a provider",id:"implementing-a-provider",level:3},{value:"Plugins which do not store personal data",id:"plugins-which-do-not-store-personal-data",level:2},{value:"Implementation requirements",id:"implementation-requirements",level:3},{value:"Example",id:"example",level:4},{value:"Plugins which store personal data",id:"plugins-which-store-personal-data",level:2},{value:"Describing the type of data you store",id:"describing-the-type-of-data-you-store",level:3},{value:"Example",id:"example-1",level:4},{value:"Indicating that you store content in a Moodle subsystem",id:"indicating-that-you-store-content-in-a-moodle-subsystem",level:4},{value:"Relevant subsystems",id:"relevant-subsystems",level:5},{value:"Example",id:"example-2",level:5},{value:"Describing data stored in database tables",id:"describing-data-stored-in-database-tables",level:4},{value:"Example",id:"example-3",level:5},{value:"Indicating that you store site-wide user preferences",id:"indicating-that-you-store-site-wide-user-preferences",level:4},{value:"Example",id:"example-4",level:5},{value:"Indicating that you export data to an external location",id:"indicating-that-you-export-data-to-an-external-location",level:4},{value:"Example",id:"example-5",level:5},{value:"Providing a way to export user data",id:"providing-a-way-to-export-user-data",level:3},{value:"Standard plugins which store data",id:"standard-plugins-which-store-data",level:4},{value:"Retrieving the list of contexts",id:"retrieving-the-list-of-contexts",level:5},{value:"Basic example",id:"basic-example",level:6},{value:"More complete example",id:"more-complete-example",level:6},{value:"Retrieving the users in a context",id:"retrieving-the-users-in-a-context",level:5},{value:"Basic example",id:"basic-example-1",level:6},{value:"Exporting user data",id:"exporting-user-data",level:5},{value:"Plugins which store user preferences",id:"plugins-which-store-user-preferences",level:4},{value:"Example",id:"example-6",level:5},{value:"Plugins which can have own subplugins",id:"plugins-which-can-have-own-subplugins",level:4},{value:"When a parent plugin should and should not provide the interface for its subplugins",id:"when-a-parent-plugin-should-and-should-not-provide-the-interface-for-its-subplugins",level:5},{value:"Example",id:"example-7",level:5},{value:"Plugins which are subplugins to another plugin",id:"plugins-which-are-subplugins-to-another-plugin",level:4},{value:"Plugins which are typically called by a Moodle subsystem",id:"plugins-which-are-typically-called-by-a-moodle-subsystem",level:4},{value:"Exporting data",id:"exporting-data",level:4},{value:"Providing a way to delete user data",id:"providing-a-way-to-delete-user-data",level:3},{value:"Delete for a context",id:"delete-for-a-context",level:4},{value:"Delete personal information for a specific user and context(s)",id:"delete-personal-information-for-a-specific-user-and-contexts",level:4},{value:"Delete personal information for several users in a specific context",id:"delete-personal-information-for-several-users-in-a-specific-context",level:4},{value:"Difference between Moodle 3.3 and more recent versions",id:"difference-between-moodle-33-and-more-recent-versions",level:2},{value:"Common Questions",id:"common-questions",level:2},{value:"What to do if you have one plugin that supports multiple branches",id:"what-to-do-if-you-have-one-plugin-that-supports-multiple-branches",level:3},{value:"Example",id:"example-8",level:4},{value:"What to do if your plugin must implement a subplugin or subsystem plugin provider",id:"what-to-do-if-your-plugin-must-implement-a-subplugin-or-subsystem-plugin-provider",level:3},{value:"Example",id:"example-9",level:4},{value:"What to do with missing userlist interfaces in legacy versions",id:"what-to-do-with-missing-userlist-interfaces-in-legacy-versions",level:3},{value:"Example",id:"example-10",level:4},{value:"Tips for development",id:"tips-for-development",level:2},{value:"See also",id:"see-also",level:2}],h={toc:c};function m(e){var t=e.components,p=(0,i.Z)(e,r);return(0,s.kt)("wrapper",(0,a.Z)({},h,p,{components:t,mdxType:"MDXLayout"}),(0,s.kt)(o.Z,(0,a.Z)({frontMatter:l},void 0!==u?{metadata:u}:{},{mdxType:"MoodlePageBanner"})),(0,s.kt)("p",null,"The ",(0,s.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/General_Data_Protection_Regulation"},"General Data Protection Regulation")," (GDPR) is an EU directive that provides users with more control over their data and how it is processed. This regulation came into effect on 25th of May 2018 and covers any citizen or permanent resident of the European Union. The directive is respected by a number of other countries outside of the European Union."),(0,s.kt)("p",null,"To help institutions become compliant with this new regulation we are adding functionality to Moodle. This includes a number of components, amongst others these include a user's right to:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"request information on the types of personal data held, the instances of that data, and the deletion policy for each;"),(0,s.kt)("li",{parentName:"ul"},"access all of their data; and"),(0,s.kt)("li",{parentName:"ul"},"be forgotten.")),(0,s.kt)("p",null,"The compliance requirements also extend to installed plugins (including third party plugins). These need to also be able to report what information they store or process regarding users, and have the ability to provide and delete data for a user request."),(0,s.kt)("p",null,"This document describes the proposed API changes required for plugins which will allow a Moodle installation to become GDPR compliant."),(0,s.kt)("p",null,"Target Audience: The intended audience for this document is Moodle plugin developers, who are aiming to ensure their plugins are updated to comply with GDPR requirements coming into effect in the EU in May, 2018."),(0,s.kt)("h2",{id:"personal-data-in-moodle"},"Personal data in Moodle"),(0,s.kt)("p",null,"From the GDPR Spec, Article 4:"),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"'personal data' means any information relating to an identified or identifiable natural person ('data subject'); an identifiable natural person is one who can be identified, directly or indirectly, in particular by reference to an identifier such as a name, an identification number, location data, an online identifier or to one or more factors specific to the physical, physiological, genetic, mental, economic, cultural or social identity of that natural person;")),(0,s.kt)("p",null,"In Moodle, we need to consider two main types of personal data; information entered by the user and information stored about the user. The key difference being that information stored about the user will have come from a source other than the user themselves. Both types of data can be used to form a profile of the individual."),(0,s.kt)("p",null,"The most obvious clue to finding personal data entered by the user is the presence of a userid on a database field. Any data on the record (or linked records) pertaining to that user may be deemed personal data for that user, including things like timestamps and record identification numbers. Additionally, any free text field which allows the user to enter information must also be considered to be the personal data of that user."),(0,s.kt)("p",null,"Data stored about the user includes things like ratings and comments made on a student submission. These may have been made by an assessor or teacher, but are considered the personal data of the student, as they are considered a reflection of the user's competency in the subject matter and can be used to form a profile of that individual."),(0,s.kt)("p",null,"The sections that follow outline what you need to do as a plugin developer to ensure any personal data is advertised and can be accessed and deleted according to the GDPR requirements."),(0,s.kt)("h2",{id:"background"},"Background"),(0,s.kt)("h3",{id:"architecture-overview"},"Architecture overview"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"UML diagram of the metadata part of the privacy subsystem",src:n(685).Z,width:"871",height:"801"}),"\n",(0,s.kt)("img",{alt:"UML diagram of the request providers part of the privacy subsystem",src:n(88416).Z,width:"1571",height:"871"})),(0,s.kt)("p",null,"A new system for Privacy has been created within Moodle. This is broken down into several main parts and forms the ",(0,s.kt)("em",{parentName:"p"},"core_privacy")," subsystem:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"Some metadata providers - a set of PHP interfaces to be implemented by components for that component to describe the kind of data that it stores, and the purpose for its storage;"),(0,s.kt)("li",{parentName:"ul"},"Some request providers - a set of PHP interfaces to be implemented by components to allow that component to act upon user requests such as the Right to be Forgotten, and a Subject Access Request; and"),(0,s.kt)("li",{parentName:"ul"},"A manager - a concrete class used to bridge components which implement the providers with tools which request their data.")),(0,s.kt)("p",null,"All plugins will implement one metadata provider, and zero, one or two request providers."),(0,s.kt)("p",null,"The 'request' providers are responsible for several separate areas:"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},"Detecting in which Moodle contexts a specific user has any personal data;"),(0,s.kt)("li",{parentName:"ol"},"Exporting all personal data from each of those contexts for that user;"),(0,s.kt)("li",{parentName:"ol"},"Deleting all personal data from each of those contexts for that user;"),(0,s.kt)("li",{parentName:"ol"},"Detecting which users have personal data in a specific Moodle context;"),(0,s.kt)("li",{parentName:"ol"},"Deleting all personal data for each of those users in that context; and"),(0,s.kt)("li",{parentName:"ol"},"Deleting all personal data for all users in a specific context.")),(0,s.kt)("p",null,"The export and delete phases use data from the detection phase, which allows for the possibility to exclude all data from certain contexts, as required."),(0,s.kt)("p",null,"Please refer to the inline phpdocs of the ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/moodle/moodle/blob/v3.5.0/privacy/classes/manager.php#L31"},"core_privacy::manager class")," for detailed description of the interfaces, their hierarchy and meaning."),(0,s.kt)("p",null,"Please note that support for locating and removing multiple users in a single context was added in ",(0,s.kt)("a",{parentName:"p",href:"https://tracker.moodle.org/browse/MDL-62560"},"MDL-62560")," for Moodle 3.6, 3.5.3, and 3.4.6.\nThis functionality has been added to allow support for removal of user data for users subject to specific role criterion, and to support expiry of the same data by role too."),(0,s.kt)("h3",{id:"implementing-a-provider"},"Implementing a provider"),(0,s.kt)("p",null,"All plugins will need to create a concrete class which implements the relevant metadata and request providers. The exact providers you need to implement will depend on what data you store, and the type of plugin. This is covered in more detail in the following sections of the document."),(0,s.kt)("p",null,"In order to do so:"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},"You must create a class called ",(0,s.kt)("em",{parentName:"li"},"provider")," within the namespace ",(0,s.kt)("inlineCode",{parentName:"li"},"\\your_pluginname\\privacy"),"."),(0,s.kt)("li",{parentName:"ol"},"This class must be created at ",(0,s.kt)("inlineCode",{parentName:"li"},"path/to/your/plugin/classes/privacy/provider.php"),"."),(0,s.kt)("li",{parentName:"ol"},"You must have your class implement the relevant metadata and request interfaces.")),(0,s.kt)("h2",{id:"plugins-which-do-not-store-personal-data"},"Plugins which do not store personal data"),(0,s.kt)("p",null,"Many Moodle plugins do not store any personal data. This is usually the case for plugins which just add functionality, or which display the data already stored elsewhere in Moodle."),(0,s.kt)("p",null,"Some examples of plugin types which might fit this criteria include themes, blocks, filters, editor plugins, etc."),(0,s.kt)("p",null,"Plugins which cause data to be stored elsewhere in Moodle (e.g. via a subsystem call) are considered to store data."),(0,s.kt)("p",null,"One examples of a plugin which does not store any data would be the Calendar month block which just displays a view of the user's calendar. It does not store any data itself."),(0,s.kt)("p",null,"An example of a plugin which must not use the null provider is the Comments block. The comments block is responsible for data subsequently being stored within Moodle. Although the block doesn't store anything itself, it interacts with the comments subsystem and is the only component which knows how that data maps to a user."),(0,s.kt)("h3",{id:"implementation-requirements"},"Implementation requirements"),(0,s.kt)("p",null,"In order to let Moodle know that you have audited your plugin, and that you do not store any personal user data, you must implement the ",(0,s.kt)("inlineCode",{parentName:"p"},"\\core_privacy\\local\\metadata\\null_provider")," interface in your plugin's provider."),(0,s.kt)("p",null,"These null providers can only be implemented where a plugin has:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"no external links (e.g. sends data to an external service like an LTI provider, repository plugin which you can search on)"),(0,s.kt)("li",{parentName:"ul"},"no database tables which store user data (including IP addresses)"),(0,s.kt)("li",{parentName:"ul"},"no user preferences")),(0,s.kt)("p",null,"The ",(0,s.kt)("inlineCode",{parentName:"p"},"null_provider")," requires you to define one function ",(0,s.kt)("inlineCode",{parentName:"p"},"get_reason()")," which returns the language string identifier within your component."),(0,s.kt)("h4",{id:"example"},"Example"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="blocks/calendar_month/classes/privacy/provider.php"',title:'"blocks/calendar_month/classes/privacy/provider.php"'}," <?php\n// \u2026\n\nnamespace block_calendar_month\\privacy;\n\nclass provider implements\n    // This plugin does not store any personal user data.\n    \\core_privacy\\local\\metadata\\null_provider {\n\n    /**\n     * Get the language string identifier with the component's language\n     * file to explain why this plugin stores no data.\n     *\n     * @return  string\n     */\n    public static function get_reason(): string {\n        return 'privacy:metadata';\n    }\n}\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="blocks/calendar_month/lang/en/block_calendar_month.php"',title:'"blocks/calendar_month/lang/en/block_calendar_month.php"'},"<?php\n// \u2026\n\n...\n$string['privacy:metadata'] = 'The Calendar block only displays existing calendar data.';\n...\n")),(0,s.kt)("p",null,"That's it. Congratulations, your plugin now implements the Privacy API."),(0,s.kt)("h2",{id:"plugins-which-store-personal-data"},"Plugins which store personal data"),(0,s.kt)("p",null,"Many Moodle plugins do store some form of personal data."),(0,s.kt)("p",null,"In some cases this will be stored within database tables in your plugin, and in other cases this will be in one of Moodle's core subsystems - for example your plugin may store files, ratings, comments, or tags."),(0,s.kt)("p",null,"Plugins which do store data will need to:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"Describe the type of data that they store;"),(0,s.kt)("li",{parentName:"ul"},"Provide a way to export that data; and"),(0,s.kt)("li",{parentName:"ul"},"Provide a way to delete that data.")),(0,s.kt)("p",null,"Data is described via a ",(0,s.kt)("em",{parentName:"p"},"metadata")," provider, and it is both exported and deleted via an implementation of a ",(0,s.kt)("em",{parentName:"p"},"request")," provider."),(0,s.kt)("p",null,"These are both explained in the sections below."),(0,s.kt)("h3",{id:"describing-the-type-of-data-you-store"},"Describing the type of data you store"),(0,s.kt)("p",null,"In order to describe the type of data that you store, you must implement the ",(0,s.kt)("inlineCode",{parentName:"p"},"\\core_privacy\\local\\metadata\\provider")," interface."),(0,s.kt)("p",null,"This interfaces requires that you define one function: ",(0,s.kt)("inlineCode",{parentName:"p"},"get_metadata"),"."),(0,s.kt)("p",null,"There are several types of item to describe the data that you store. These are for:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"Items in the Moodle database;"),(0,s.kt)("li",{parentName:"ul"},"Items stored by you in a Moodle subsystem - for example files, and ratings; and"),(0,s.kt)("li",{parentName:"ul"},"User preferences stored site-wide within Moodle for your plugin")),(0,s.kt)("p",null,"Note: All fields should include a description from a language string within your plugin."),(0,s.kt)("h4",{id:"example-1"},"Example"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/forum/classes/privacy/provider.php"',title:'"mod/forum/classes/privacy/provider.php"'},"<?php\n// \u2026\n\nnamespace mod_forum\\privacy;\nuse core_privacy\\local\\metadata\\collection;\n\nclass provider implements\n        // This plugin does store personal user data.\n        \\core_privacy\\local\\metadata\\provider {\n\n    public static function get_metadata(collection $collection): collection {\n\n        // Here you will add more items into the collection.\n\n        return $collection;\n    }\n}\n")),(0,s.kt)("h4",{id:"indicating-that-you-store-content-in-a-moodle-subsystem"},"Indicating that you store content in a Moodle subsystem"),(0,s.kt)("p",null,"Many plugins will use one of the core Moodle subsystems to store data."),(0,s.kt)("p",null,"As a plugin developer we do not expect you to describe those subsystems in detail, but we do need to know that you use them and to know what you use them for."),(0,s.kt)("p",null,"You can indicate this by calling the ",(0,s.kt)("inlineCode",{parentName:"p"},"add_subsystem_link()")," method on the ",(0,s.kt)("inlineCode",{parentName:"p"},"collection"),"."),(0,s.kt)("h5",{id:"relevant-subsystems"},"Relevant subsystems"),(0,s.kt)("p",null,"You are likely to need to indicate use of the following subsystems that store user data:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"Ratings (if users are allowed to rate items within your plugin)"),(0,s.kt)("li",{parentName:"ul"},"Tags (if users can tag items within your plugin)"),(0,s.kt)("li",{parentName:"ul"},"Comments (if users can make comments on items in your plugin)"),(0,s.kt)("li",{parentName:"ul"},"Questions (if the plugin uses core question types)"),(0,s.kt)("li",{parentName:"ul"},"Filesystem (if users can attach files to items within your plugin)"),(0,s.kt)("li",{parentName:"ul"},"...?")),(0,s.kt)("p",null,"Some subsystems which store user data do not need to be listed:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"(TBC - how about global search? Nothing lists it that I could see.)")),(0,s.kt)("h5",{id:"example-2"},"Example"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/forum/classes/privacy/provider.php"',title:'"mod/forum/classes/privacy/provider.php"'},"public static function get_metadata(collection $collection): collection {\n\n    $collection->add_subsystem_link(\n        'core_files',\n        [],\n        'privacy:metadata:core_files'\n    );\n\n    return $collection;\n}\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/forum/lang/en/forum.php"',title:'"mod/forum/lang/en/forum.php"'},"<?php\n\n$string['privacy:metadata:core_files'] = 'The forum stores files which have been uploaded by the user to form part of a forum post.';\n")),(0,s.kt)("h4",{id:"describing-data-stored-in-database-tables"},"Describing data stored in database tables"),(0,s.kt)("p",null,"Most Moodle plugins will store some form of user data in their own database tables."),(0,s.kt)("p",null,"As a plugin developer you will need to describe each database table, and each field which includes user data."),(0,s.kt)("p",null,"It is a matter of judgement which fields contain user data and which don't. Anything entered by, or directly about, the user probably counts as user data but it may be useful to include additional fields that explain the context of the data."),(0,s.kt)("h5",{id:"example-3"},"Example"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/forum/classes/privacy/provider.php"',title:'"mod/forum/classes/privacy/provider.php"'},"public static function get_metadata(collection $collection): collection {\n\n    $collection->add_database_table(\n        'forum_discussion_subs',\n         [\n            'userid' => 'privacy:metadata:forum_discussion_subs:userid',\n            'discussionid' => 'privacy:metadata:forum_discussion_subs:discussionid',\n            'preference' => 'privacy:metadata:forum_discussion_subs:preference',\n\n         ],\n        'privacy:metadata:forum_discussion_subs'\n    );\n\n    return $collection;\n}\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/forum/lang/en/forum.php"',title:'"mod/forum/lang/en/forum.php"'},"<?php\n\n$string['privacy:metadata:forum_discussion_subs'] = 'Information about the subscriptions to individual forum discussions. This includes when a user has chosen to subscribe to a discussion, or to unsubscribe from one where they would otherwise be subscribed.';\n$string['privacy:metadata:forum_discussion_subs:userid'] = 'The ID of the user with this subscription preference.';\n$string['privacy:metadata:forum_discussion_subs:discussionid'] = 'The ID of the discussion that was subscribed to.';\n$string['privacy:metadata:forum_discussion_subs:preference'] = 'The start time of the subscription.';\n")),(0,s.kt)("h4",{id:"indicating-that-you-store-site-wide-user-preferences"},"Indicating that you store site-wide user preferences"),(0,s.kt)("p",null,"Many plugins will include one or more user preferences. Unfortunately this is one of Moodle's older components and many of the values stored are not pure user preferences. Each plugin should be aware of how it handles its own preferences and is best placed to determine whether they are site-wide preferences, or per-instance preferences."),(0,s.kt)("p",null,"Whilst most of these will have a fixed name (e.g. ",(0,s.kt)("inlineCode",{parentName:"p"},"filepicker_recentrepository"),"), some will include a variable of some kind (e.g. ",(0,s.kt)("inlineCode",{parentName:"p"},"tool_usertours_tour_completion_time_2"),'). Only the general name (in this case "tool',(0,s.kt)("em",{parentName:"p"},"usertours_tour_completion_time"),'") needs to be indicated, rather than one copy for each possible value of the variable.'),(0,s.kt)("p",null,"Also, these should only be ",(0,s.kt)("em",{parentName:"p"},"site-wide")," user preferences which do not belong to a specific Moodle context."),(0,s.kt)("p",null,"In the above examples:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"Preference ",(0,s.kt)("inlineCode",{parentName:"li"},"filepicker_recentrepository")," belongs to the file subsystem, and is a site-wide preference affecting the user anywhere that they view the filepicker."),(0,s.kt)("li",{parentName:"ul"},"Preference ",(0,s.kt)("inlineCode",{parentName:"li"},"tool_usertours_tour_completion_time_2")," belongs to user tours. User tours are a site-wide feature which can affect many parts of Moodle and cross multiple contexts.")),(0,s.kt)("p",null,"In some cases a value may be stored in the preferences table but is known to belong to a specific context within Moodle. In these cases they should be stored as metadata against that context rather than as a site-wide user preference."),(0,s.kt)("p",null,"You can indicate this by calling the ",(0,s.kt)("inlineCode",{parentName:"p"},"add_user_preference()")," method on the ",(0,s.kt)("em",{parentName:"p"},"collection"),"."),(0,s.kt)("p",null,"Any plugin providing user preferences must also implement the ",(0,s.kt)("inlineCode",{parentName:"p"},"\\core_privacy\\local\\request\\user_preference_provider"),"."),(0,s.kt)("h5",{id:"example-4"},"Example"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="admin/tool/usertours/classes/privacy/provider.php"',title:'"admin/tool/usertours/classes/privacy/provider.php"'},"public static function get_metadata(collection $collection): collection {\n\n    $collection->add_user_preference('tool_usertours_tour_completion_time',\n        'privacy:metadata:preference:tool_usertours_tour_completion_time');\n\n    return $collection;\n}\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="admin/tool/usertours/lang/en/tool_usertours.php"',title:'"admin/tool/usertours/lang/en/tool_usertours.php"'},"<?php\n\n$string['privacy:metadata:tool_usertours_tour_completion_time'] = 'The time that a specific user tour was last completed by a user.';\n")),(0,s.kt)("h4",{id:"indicating-that-you-export-data-to-an-external-location"},"Indicating that you export data to an external location"),(0,s.kt)("p",null,"Many plugins will interact with external systems - for example cloud-based services. Often this external location is configurable within the plugin either at the site or the instance level."),(0,s.kt)("p",null,"As a plugin developer you will need to describe each ",(0,s.kt)("em",{parentName:"p"},"type")," of target destination, alongside a list of each exported field which includes user data.\nThe ",(0,s.kt)("em",{parentName:"p"},"actual")," destination does not need to be described as this can change based on configuration."),(0,s.kt)("p",null,"You can indicate this by calling the ",(0,s.kt)("inlineCode",{parentName:"p"},"add_external_location_link()")," method on the collection."),(0,s.kt)("h5",{id:"example-5"},"Example"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/lti/classes/privacy/provider.php"',title:'"mod/lti/classes/privacy/provider.php"'},"public static function get_metadata(collection $collection): collection {\n    $collection->add_external_location_link('lti_client', [\n            'userid' => 'privacy:metadata:lti_client:userid',\n            'fullname' => 'privacy:metadata:lti_client:fullname',\n        ], 'privacy:metadata:lti_client');\n\n    return $collection;\n}\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/lti/lang/en/lti.php"',title:'"mod/lti/lang/en/lti.php"'},"<?php\n\n$string['privacy:metadata:lti_client'] = 'In order to integrate with a remote LTI service, user data needs to be exchanged with that service.';\n$string['privacy:metadata:lti_client:userid'] = 'The userid is sent from Moodle to allow you to access your data on the remote system.';\n$string['privacy:metadata:lti_client:fullname'] = 'Your full name is sent to the remote system to allow a better user experience.';\n")),(0,s.kt)("h3",{id:"providing-a-way-to-export-user-data"},"Providing a way to export user data"),(0,s.kt)("p",null,"In order to export the user data that you store, you must implement the relevant request provider."),(0,s.kt)("p",null,"We have named these request providers because they are called in response to a specific request from a user to access their information, however they also deal with the removal of user data following it's expiry."),(0,s.kt)("p",null,"There are several different types of request provider, and you may need to implement several of these, depending on the type and nature of your plugin."),(0,s.kt)("p",null,"Broadly speaking plugins will fit into one of the following categories:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"Plugins which are a subplugin of another plugin. Examples include ",(0,s.kt)("em",{parentName:"li"},"assignsubmission"),", ",(0,s.kt)("em",{parentName:"li"},"atto"),", and ",(0,s.kt)("em",{parentName:"li"},"datafield"),";"),(0,s.kt)("li",{parentName:"ul"},"Plugins which are typically called by a Moodle subsystem. Examples include ",(0,s.kt)("em",{parentName:"li"},"qtype"),", and ",(0,s.kt)("em",{parentName:"li"},"profilefield"),";"),(0,s.kt)("li",{parentName:"ul"},"All other plugins which store data.")),(0,s.kt)("p",null,"Most plugins will fit into this final category, whilst other plugins may fall into several categories.\nPlugins which ",(0,s.kt)("em",{parentName:"p"},"define")," a subplugin will also be responsible for  collecting this data from their subplugins."),(0,s.kt)("p",null,"A final category exists - plugins which store user preferences. In some cases this may be the ",(0,s.kt)("em",{parentName:"p"},"only")," provider implemented."),(0,s.kt)("h4",{id:"standard-plugins-which-store-data"},"Standard plugins which store data"),(0,s.kt)("p",null,"A majority of Moodle plugins will fit into this category and will be required to implement the ",(0,s.kt)("inlineCode",{parentName:"p"},"\\core_privacy\\local\\request\\plugin\\provider")," interface. This interface requires that you define four functions (the first two of which are dealt with in this section):"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"get_contexts_for_userid")," - to explain where data is held within Moodle for your plugin; and"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"export_user_data")," - to export a user's personal data from your plugin."),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"delete_data_for_all_users_in_context")," - to delete all data for all users in the specified context."),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"delete_data_for_user")," - to delete all user data for the specified user, in the specified contexts.")),(0,s.kt)("p",null,"These APIs make use of the Moodle ",(0,s.kt)("em",{parentName:"p"},"context")," system to hierarchically store this data."),(0,s.kt)("p",null,"In addition to these requirements, since Moodle 3.4.6, 3.5.3, any plugin which implements the plugin provider interface must also implement the ",(0,s.kt)("inlineCode",{parentName:"p"},"\\core_privacy\\local\\request\\core_userlist_provider")," provider and implement functions:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"get_users_in_context")," - to locate the users who hold any personal data in a specific context; and"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"delete_data_for_users")," - to delete data for multiple users in the specified context.")),(0,s.kt)("p",null,"A polyfill has not been provided for this new interface, but we recognise that developers who are maintaining older versions (Moodle 3.3) will hit problems with this new interface not existing. We recommend doing something similar to the following example."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php"},"<?php\n\nnamespace assignsubmission_example\\privacy;\n\nif (interface_exists('\\core_privacy\\local\\request\\userlist')) {\n    interface my_userlist extends \\core_privacy\\local\\request\\userlist{}\n} else {\n    interface my_userlist {};\n}\n\n\nclass provider implements my_userlist {\n\n    /**\n     * Get the list of users who have data within a context.\n     *\n     * @param   userlist    $userlist   The userlist containing the list of users who have data in this context/plugin combination.\n     */\n    public static function get_users_in_context(userlist $userlist) {\n\n    }\n\n    /**\n     * Delete multiple users within a single context.\n     *\n     * @param   approved_userlist       $userlist The approved context and user information to delete information for.\n     */\n    public static function delete_data_for_users(approved_userlist $userlist) {\n\n    }\n\n}\n")),(0,s.kt)("h5",{id:"retrieving-the-list-of-contexts"},"Retrieving the list of contexts"),(0,s.kt)("p",null,"You are required to return the list of contexts for which the plugin stores data about the user. These are the standard Moodle contexts - CONTEXT_COURSE, CONTEXT_USER, CONTEXT_MODULE and so on. In many cases the link between the module type and the context is self-evident (e.g. activity modules). In some cases it may be less so. For example, an enrolment plugin (that stores user data, which most don't) would link to course context (users enrol in courses). Other types of plugins may be less obvious but you need to pick something. One way might to consider what context you would use when checking role capabilities. Consider that this will be used to structure the exported data and define what data is deleted when a context is expired."),(0,s.kt)("p",null,"Contexts are retrieved using the ",(0,s.kt)("inlineCode",{parentName:"p"},"get_contexts_for_userid")," function which takes the ID of the user being fetched, and returns a list of contexts in which the user has any data."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/forum/classes/privacy/provider.php"',title:'"mod/forum/classes/privacy/provider.php"'},"/**\n * Get the list of contexts that contain user information for the specified user.\n *\n * @param   int           $userid       The user to search.\n * @return  contextlist   $contextlist  The list of contexts used in this plugin.\n */\npublic static function get_contexts_for_userid(int $userid): contextlist {}\n")),(0,s.kt)("p",null,"The function returns a ",(0,s.kt)("inlineCode",{parentName:"p"},"\\core_privacy\\local\\request\\contextlist")," which is used to keep a set of contexts together in a fixed fashion."),(0,s.kt)("p",null,"Because a Subject Access Request covers ",(0,s.kt)("em",{parentName:"p"},"every")," piece of data that is held for a user within Moodle, efficiency and performance is highly important. As a result, contexts are added to the ",(0,s.kt)("em",{parentName:"p"},"contextlist")," by defining one or more SQL queries which return just the contextid. Multiple SQL queries can be added as required."),(0,s.kt)("p",null,"Many plugins will interact with specific subsystems and store data within them.\nThese subsystems will also provide a way in which to link the data that you have stored with your own database tables.\nAt present these are still a work in progress and only the ",(0,s.kt)("em",{parentName:"p"},"core_ratings")," subsystem includes this."),(0,s.kt)("h6",{id:"basic-example"},"Basic example"),(0,s.kt)("p",null,"The following example simply fetches the contextid for all forums where a user has a single discussion (note: this is an incomplete example):"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/forum/classes/privacy/provider.php"',title:'"mod/forum/classes/privacy/provider.php"'},"/**\n * Get the list of contexts that contain user information for the specified user.\n *\n * @param   int           $userid       The user to search.\n * @return  contextlist   $contextlist  The list of contexts used in this plugin.\n */\npublic static function get_contexts_for_userid(int $userid): contextlist {\n    $contextlist = new \\core_privacy\\local\\request\\contextlist();\n\n    $sql = \"SELECT c.id\n                FROM {context} c\n        INNER JOIN {course_modules} cm ON cm.id = c.instanceid AND c.contextlevel = :contextlevel\n        INNER JOIN {modules} m ON m.id = cm.module AND m.name = :modname\n        INNER JOIN {forum} f ON f.id = cm.instance\n        LEFT JOIN {forum_discussions} d ON d.forum = f.id\n            WHERE (\n            d.userid        = :discussionuserid\n            )\n    \";\n\n    $params = [\n        'modname'           => 'forum',\n        'contextlevel'      => CONTEXT_MODULE,\n        'discussionuserid'  => $userid,\n    ];\n\n    $contextlist->add_from_sql($sql, $params);\n\n    return $contextlist;\n}\n")),(0,s.kt)("h6",{id:"more-complete-example"},"More complete example"),(0,s.kt)("p",null,"The following example includes a link to core_rating.\nIt will find any forum, forum discussion, or forum post where the user has any data, including:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"Per-forum digest preferences;"),(0,s.kt)("li",{parentName:"ul"},"Per-forum subscription preferences;"),(0,s.kt)("li",{parentName:"ul"},"Per-forum read tracking preferences;"),(0,s.kt)("li",{parentName:"ul"},"Per-discussion subscription preferences;"),(0,s.kt)("li",{parentName:"ul"},"Per-post read data (if a user has read a post or not); and"),(0,s.kt)("li",{parentName:"ul"},"Per-post rating data.")),(0,s.kt)("p",null,"In the case of the rating data, this will include any post where the user has rated the post of another user."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/forum/classes/privacy/provider.php"',title:'"mod/forum/classes/privacy/provider.php"'},"/**\n * Get the list of contexts that contain user information for the specified user.\n *\n * @param   int           $userid       The user to search.\n * @return  contextlist   $contextlist  The list of contexts used in this plugin.\n */\npublic static function get_contexts_for_userid(int $userid): contextlist {\n    $ratingsql = \\core_rating\\privacy\\provider::get_sql_join('rat', 'mod_forum', 'post', 'p.id', $userid);\n    // Fetch all forum discussions, and forum posts.\n    $sql = \"SELECT c.id\n                FROM {context} c\n        INNER JOIN {course_modules} cm ON cm.id = c.instanceid AND c.contextlevel = :contextlevel\n        INNER JOIN {modules} m ON m.id = cm.module AND m.name = :modname\n        INNER JOIN {forum} f ON f.id = cm.instance\n            LEFT JOIN {forum_discussions} d ON d.forum = f.id\n            LEFT JOIN {forum_posts} p ON p.discussion = d.id\n            LEFT JOIN {forum_digests} dig ON dig.forum = f.id\n            LEFT JOIN {forum_subscriptions} sub ON sub.forum = f.id\n            LEFT JOIN {forum_track_prefs} pref ON pref.forumid = f.id\n            LEFT JOIN {forum_read} hasread ON hasread.forumid = f.id\n            LEFT JOIN {forum_discussion_subs} dsub ON dsub.forum = f.id\n            {$ratingsql->join}\n                WHERE (\n                p.userid        = :postuserid OR\n                d.userid        = :discussionuserid OR\n                dig.userid      = :digestuserid OR\n                sub.userid      = :subuserid OR\n                pref.userid     = :prefuserid OR\n                hasread.userid  = :hasreaduserid OR\n                dsub.userid     = :dsubuserid OR\n                {$ratingsql->userwhere}\n            )\n    \";\n\n    $params = [\n        'modname'           => 'forum',\n        'contextlevel'      => CONTEXT_MODULE,\n        'postuserid'        => $userid,\n        'discussionuserid'  => $userid,\n        'digestuserid'      => $userid,\n        'subuserid'         => $userid,\n        'prefuserid'        => $userid,\n        'hasreaduserid'     => $userid,\n        'dsubuserid'        => $userid,\n    ];\n    $params += $ratingsql->params;\n\n    $contextlist = new \\core_privacy\\local\\request\\contextlist();\n    $contextlist->add_from_sql($sql, $params);\n\n    return $contextlist;\n\n\n}\n")),(0,s.kt)("h5",{id:"retrieving-the-users-in-a-context"},"Retrieving the users in a context"),(0,s.kt)("p",null,"You are required to return the list of users holding personal data in a context for which the plugin stores data about the user. This should only be data from that one context. Do not include subcontexts.\nThis method is very similar to the ",(0,s.kt)("inlineCode",{parentName:"p"},"get_contexts_for_userid")," function but has some important distinctions:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"It takes a ",(0,s.kt)("inlineCode",{parentName:"li"},"userlist")," as an argument and does not require that you, as a developer, create it yourself;"),(0,s.kt)("li",{parentName:"ul"},"There is no need to return any value; and"),(0,s.kt)("li",{parentName:"ul"},"The argument for the ",(0,s.kt)("inlineCode",{parentName:"li"},"userlist::add_from_sql")," are different to those for ",(0,s.kt)("inlineCode",{parentName:"li"},"contextlist::add_from_sql")," (this is because we learnt some important lessons after the initial implementation).")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php"},"/**\n * Get the list of users who have data within a context.\n *\n * @param userlist $userlist The userlist containing the list of users who have data in this context/plugin combination.\n */\npublic static function get_users_in_context(userlist $userlist) {}\n")),(0,s.kt)("h6",{id:"basic-example-1"},"Basic example"),(0,s.kt)("p",null,"The following example simply fetches the userid for all users in a given forum context, who created a discussion or a post in that forum (note: this is an incomplete example):"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/forum/classes/privacy/provider.php"',title:'"mod/forum/classes/privacy/provider.php"'},"/**\n * Get the list of users who have data within a context.\n *\n * @param userlist $userlist The userlist containing the list of users who have data in this context/plugin combination.\n */\npublic static function get_users_in_context(userlist $userlist) {\n\n    $context = $userlist->get_context();\n\n    if (!$context instanceof \\context_module) {\n        return;\n    }\n\n    $params = [\n        'instanceid'    => $context->instanceid,\n        'modulename'    => 'forum',\n    ];\n\n    // Discussion authors.\n    $sql = \"SELECT d.userid\n              FROM {course_modules} cm\n              JOIN {modules} m ON m.id = cm.module AND m.name = :modulename\n              JOIN {forum} f ON f.id = cm.instance\n              JOIN {forum_discussions} d ON d.forum = f.id\n             WHERE cm.id = :instanceid\";\n    $userlist->add_from_sql('userid', $sql, $params);\n\n     // Forum authors.\n    $sql = \"SELECT p.userid\n              FROM {course_modules} cm\n              JOIN {modules} m ON m.id = cm.module AND m.name = :modulename\n              JOIN {forum} f ON f.id = cm.instance\n              JOIN {forum_discussions} d ON d.forum = f.id\n              JOIN {forum_posts} p ON d.id = p.discussion\n             WHERE cm.id = :instanceid\";\n    $userlist->add_from_sql('userid', $sql, $params);\n\n    // ...\n}\n")),(0,s.kt)("h5",{id:"exporting-user-data"},"Exporting user data"),(0,s.kt)("p",null,"After determining where in Moodle your plugin holds data about a user, the ",(0,s.kt)("inlineCode",{parentName:"p"},"\\core_privacy\\manager")," will then ask your plugin to export all user data for a subset of those locations."),(0,s.kt)("p",null,"This is achieved through use of the ",(0,s.kt)("inlineCode",{parentName:"p"},"export_user_data")," function which takes the list of approved contexts in a ",(0,s.kt)("inlineCode",{parentName:"p"},"\\core_privacy\\local\\request\\approved_contextlist")," object."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/forum/classes/privacy/provider.php"',title:'"mod/forum/classes/privacy/provider.php"'},"/**\n * Export all user data for the specified user, in the specified contexts, using the supplied exporter instance.\n *\n * @param   approved_contextlist    $contextlist    The approved contexts to export information for.\n */\npublic static function export_user_data(approved_contextlist $contextlist) {}\n")),(0,s.kt)("p",null,"The ",(0,s.kt)("inlineCode",{parentName:"p"},"approved_contextlist")," includes both the user record, and a list of contexts, which can be retrieved by either processing it as an Iterator, or by calling ",(0,s.kt)("inlineCode",{parentName:"p"},"get_contextids()")," or ",(0,s.kt)("inlineCode",{parentName:"p"},"get_contexts()")," as required."),(0,s.kt)("p",null,"Data is exported using a ",(0,s.kt)("inlineCode",{parentName:"p"},"\\core_privacy\\local\\request\\content_writer"),", which is described in further detail below."),(0,s.kt)("h4",{id:"plugins-which-store-user-preferences"},"Plugins which store user preferences"),(0,s.kt)("p",null,"Many plugins store a variety of user preferences, and must therefore export them."),(0,s.kt)("p",null,"Since user preferences are a site-wide preference, these are exported separately to other user data.\nIn some cases the only data present is user preference data, whilst in others there is a combination of user-provided data, and user preferences."),(0,s.kt)("p",null,"Storing of user preferences is achieved through implementation of the ",(0,s.kt)("inlineCode",{parentName:"p"},"\\core_privacy\\local\\request\\user_preference_provider")," interface which defines one required function -- ",(0,s.kt)("inlineCode",{parentName:"p"},"export_user_preferences"),"."),(0,s.kt)("p",null,"You need to provide a description of the value of the user preference. (This description is particularly useful in cases where the value might be, say, 3, but it actually means 'Alphabetical order'.) Most likely you can use an existing language string from your plugin."),(0,s.kt)("h5",{id:"example-6"},"Example"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/forum/classes/privacy/provider.php"',title:'"mod/forum/classes/privacy/provider.php"'},"/**\n * Export all user preferences for the plugin.\n *\n * @param   int         $userid The userid of the user whose data is to be exported.\n */\npublic static function export_user_preferences(int $userid) {\n    $markasreadonnotification = get_user_preference('markasreadonnotification', null, $userid);\n    if (null !== $markasreadonnotification) {\n        switch ($markasreadonnotification) {\n            case 0:\n                $markasreadonnotificationdescription = get_string('markasreadonnotificationno', 'mod_forum');\n                break;\n            case 1:\n            default:\n                $markasreadonnotificationdescription = get_string('markasreadonnotificationyes', 'mod_forum');\n                break;\n        }\n        writer::export_user_preference('mod_forum', 'markasreadonnotification', $markasreadonnotification, $markasreadonnotificationdescription);\n    }\n}\n")),(0,s.kt)("h4",{id:"plugins-which-can-have-own-subplugins"},"Plugins which can have own subplugins"),(0,s.kt)("p",null,"Many plugin types are also able to define their own subplugins and will need to define a contract between themselves and their subplugins in order to fetch their data."),(0,s.kt)("p",null,"This is required as the parent plugin and the child subplugin should be separate entities and the parent plugin must be able to function if one or more of its subplugins are uninstalled."),(0,s.kt)("p",null,"The parent plugin is responsible for defining the contract,  and for interacting with its subplugins, though we intend to create helpers to make this easier."),(0,s.kt)("p",null,"The parent plugin should define a new interface for each type of subplugin that it defines. This interface should extend the ",(0,s.kt)("inlineCode",{parentName:"p"},"\\core_privacy\\local\\request\\plugin\\subplugin_provider")," interface."),(0,s.kt)("h5",{id:"when-a-parent-plugin-should-and-should-not-provide-the-interface-for-its-subplugins"},"When a parent plugin should and should not provide the interface for its subplugins"),(0,s.kt)("p",null,'There can be cases when there is no point for a plugin to provide the "subplugin_provider" based interface, even if it has own subplugins. See the Atto or TinyMCE editors as real examples.'),(0,s.kt)("p",null,"If the parent plugin has no data passed through to the subplugins, there is no benefit in defining a subplugin provider. For example, Atto subplugins are just used to enhance the functionality and they never receive anything like a context. Most of the time we need to define a subplugin provider, but in cases where there is no data passed from the plugin to its subplugins, there is no need to define the subplugin provider. If the subplugins still do store personal data that are not related to the parent plugin in any way, then subplugins should define their own standard provider."),(0,s.kt)("p",null,"Compare with something like mod_assign where the subplugins store data for the parent and that data is contextually relevant to the parent plugin. In those cases the subplugin stores data for the plugin and it only makes sense to do so in the context of its parent plugin."),(0,s.kt)("h5",{id:"example-7"},"Example"),(0,s.kt)("p",null,"The following example defines the contract that assign submission subplugins may be required to implement."),(0,s.kt)("p",null,"The assignment module is responsible for returning the contexts of all assignments where a user has data, but in some cases it is unaware of all of those cases - for example if a Teacher comments on a student submission it may not be aware of these as the information about this interaction may not be stored within its own tables."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/assign/privacy/assignsubmission_provider.php"',title:'"mod/assign/privacy/assignsubmission_provider.php"'},"<?php\n// \u2026\n\nnamespace mod_assign\\privacy;\nuse \\core_privacy\\local\\metadata\\collection;\n\n\ninterface assignsubmission_provider extends\n    // This Interface defines a subplugin.\n    \\core_privacy\\local\\request\\plugin\\subplugin_provider {\n\n    /**\n     * Get the SQL required to find all submission items where this user has had any involvements.\n     *\n     * @param   int           $userid       The user to search.\n     * @return  \\stdClass                   Object containing the join, params, and where used to select a these records from the database.\n     */\n    public static function get_items_with_user_interaction(int $userid): \\stdClass ;\n\n    /**\n     * Export all relevant user submissions information which match the combination of userid and attemptid.\n     *\n     * @param   int           $userid       The user to search.\n     * @param   \\context      $context      The context to export this submission against.\n     * @param   array         $subcontext   The subcontext within the context to export this information\n     * @param   int           $attid        The id of the submission to export.\n     */\n    public static function export_user_submissions(int $userid, \\context $context, array $subcontext, int $attid) ;\n\n}\n")),(0,s.kt)("h4",{id:"plugins-which-are-subplugins-to-another-plugin"},"Plugins which are subplugins to another plugin"),(0,s.kt)("p",null,"If you are developing a sub-plugin of another plugin, then you will have to look at the relevant plugin in order to determine the exact contract."),(0,s.kt)("p",null,"Each subplugin type should define a new interface which extends the ",(0,s.kt)("inlineCode",{parentName:"p"},"\\core_privacy\\local\\request\\plugin\\subplugin_provider")," interface and it is up to the parent plugin to define how they will interact with their children."),(0,s.kt)("p",null,"The principles remain the same, but the exact implementation will differ depending upon requirements."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/pluginname/classes/privacy/provider.php"',title:'"mod/pluginname/classes/privacy/provider.php"'},"<?php\n// \u2026\nnamespace assignsubmission\\onlinetext;\n\nclass provider implements\n    // This plugin does store personal user data.\n    \\core_privacy\\local\\metadata\\provider,\n\n    // This plugin is a subplugin of assign and must meet that contract.\n    \\mod_assign\\privacy\\assignsubmission_provider {\n}\n")),(0,s.kt)("h4",{id:"plugins-which-are-typically-called-by-a-moodle-subsystem"},"Plugins which are typically called by a Moodle subsystem"),(0,s.kt)("p",null,"There are a number of plugintypes in Moodle which are typically called by a specific Moodle subsystem."),(0,s.kt)("p",null,"Some of these are ",(0,s.kt)("em",{parentName:"p"},"only")," called by that subsystem, for example plugins which are of the ",(0,s.kt)("em",{parentName:"p"},"plagiarism")," plugintype should never be called directly, but are always invoked via the ",(0,s.kt)("em",{parentName:"p"},"core_plagiarism")," subsystem."),(0,s.kt)("p",null,"Conversely, there maybe other plugintypes which can be called both via a subsystem, and in some other fashion. We are still determining whether any plugintypes currently fit this pattern."),(0,s.kt)("p",null,"If you are developing a plugin which belongs to a specific subsystem, then you will have to look at the relevant plugin in order to determine the exact contract."),(0,s.kt)("p",null,"Each subsystem will define a new interface which extends the ",(0,s.kt)("inlineCode",{parentName:"p"},"\\core_privacy\\local\\request\\plugin\\subsystem_provider")," interface and it is up to that subsystem to define how they will interact with those plugins."),(0,s.kt)("p",null,"The principles remain the same, but the exact implementation will differ depending upon requirements."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="plagiarism/detectorator/classes/privacy/provider.php"',title:'"plagiarism/detectorator/classes/privacy/provider.php"'},"<?php\n// \u2026\nnamespace plagiarism_detectorator\\privacy;\n\nclass provider implements\n    // This plugin does export personal user data.\n    \\core_privacy\\local\\metadata\\provider,\n\n    // This plugin is always linked against another activity module via the Plagiarism API.\n    \\core_plagiarism\\privacy\\plugin_provider {\n}\n")),(0,s.kt)("h4",{id:"exporting-data"},"Exporting data"),(0,s.kt)("p",null,"Any plugin which stores data must also export it."),(0,s.kt)("p",null,"To cater for this the privacy API includes a ",(0,s.kt)("inlineCode",{parentName:"p"},"\\core_privacy\\local\\request\\content_writer"),", which defines a set of functions to store different types of data."),(0,s.kt)("p",null,"Broadly speaking data is broken into the following types:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"Data - this is the object being described. For example the post content in a forum post;"),(0,s.kt)("li",{parentName:"ul"},"Related data - this is data related to the object being stored. For example, ratings of a forum post;"),(0,s.kt)("li",{parentName:"ul"},"Metadata - This is metadata about the main object. For example whether you are subscribed to a forum discussion;"),(0,s.kt)("li",{parentName:"ul"},"User preferences - this is data about a site-wide preference;"),(0,s.kt)("li",{parentName:"ul"},"Files - Any files that you are stored within Moodle on behalf of this plugin; and"),(0,s.kt)("li",{parentName:"ul"},"Custom files - For custom file formats - e.g. a calendar feed for calendar data. These should be used sparingly.")),(0,s.kt)("p",null,"Each piece of data is stored against a specific Moodle ",(0,s.kt)("em",{parentName:"p"},"context"),", which will define how the data is structured within the exporter.\nData, and Related data only accept the ",(0,s.kt)("em",{parentName:"p"},"stdClass")," object, whilst metadata should be stored as a set of key/value pairs which include a description."),(0,s.kt)("p",null,"In some cases the data being stored belongs within an implicit structure. For example, one forum has many forum discussions, which each have a number of forum posts. This structure is represented by an ",(0,s.kt)("em",{parentName:"p"},"array")," referred to as a ",(0,s.kt)("em",{parentName:"p"},"subcontext"),"."),(0,s.kt)("p",null,"The ",(0,s.kt)("em",{parentName:"p"},"content_writer")," must ",(0,s.kt)("em",{parentName:"p"},"always")," be called with a specific context, and can be called as follows:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/forum/classes/privacy/provider.php"',title:'"mod/forum/classes/privacy/provider.php"'},"<?php\n// \u2026\nuse \\core_privacy\\local\\request\\writer;\n\nwriter::with_context($context)\n    ->export_data($subcontext, $post)\n    ->export_area_files($subcontext, 'mod_forum', 'post', $post->id)\n    ->export_metadata($subcontext, 'postread', (object) ['firstread' => $firstread], new \\lang_string('privacy:export:post:postread'));\n")),(0,s.kt)("p",null,"Any text field which supports Moodle files must also be rewritten:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/forum/classes/privacy/provider.php"',title:'"mod/forum/classes/privacy/provider.php"'},"<?php\n// \u2026\nuse \\core_privacy\\local\\request\\writer;\n\n$post->message = writer::with_context($context)\n    ->rewrite_pluginfile_urls($subcontext, 'mod_forum', 'post', $post->id, $post->message);\n\n")),(0,s.kt)("h3",{id:"providing-a-way-to-delete-user-data"},"Providing a way to delete user data"),(0,s.kt)("p",null,"Deleting user data is also implemented in the request interface. There are two methods that need to be created. The first one to remove all user data from a context, the other to remove user data for a specific user in a list of contexts."),(0,s.kt)("h4",{id:"delete-for-a-context"},"Delete for a context"),(0,s.kt)("p",null,"A context is given and all user data (for all users) is to be deleted from the plugin. This will be called when the retention period for the context has expired to adhere to the privacy by design requirement. Retention periods are set in the Data registry."),(0,s.kt)("p",null,"Note that this will be called for ",(0,s.kt)("strong",{parentName:"p"},"any")," context being expired, not only those the plugin holds data for (as returned by get_contexts_for_userid()), so you must carefully check the contexts given."),(0,s.kt)("p",null,"When expiring content for a high-level context such as a course context, the function will be called not only with the course context but also with each context within the course: each module context, each block context, etc. At each level you should only expire data specifically related to that exact context. For a module plugin, this generally means you should only take action for CONTEXT_MODULE contexts and only if they relate to an instance of your module, as shown in the following example. (In the rare case where your module also stores user data related to the course, and not just for a module instance, then you do need to implement CONTEXT_COURSE level contexts to expire that course-level data.)"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php"},"/**\n * Delete all personal data for all users in the specified context.\n *\n * @param context $context Context to delete data from.\n */\npublic static function delete_data_for_all_users_in_context(\\context $context) {\n    global $DB;\n\n    if ($context->contextlevel != CONTEXT_MODULE) {\n        return;\n    }\n\n    $cm = get_coursemodule_from_id('choice', $context->instanceid);\n    if (!$cm) {\n        return;\n    }\n\n    $DB->delete_records('choice_answers', ['choiceid' => $cm->instance]);\n}\n")),(0,s.kt)("h4",{id:"delete-personal-information-for-a-specific-user-and-contexts"},"Delete personal information for a specific user and context(s)"),(0,s.kt)("p",null,"An ",(0,s.kt)("em",{parentName:"p"},"approved_contextlist")," is given and user data related to that user should either be completely deleted, or overwritten if a structure needs to be maintained. This will be called when a user has requested the right to be forgotten. All attempts should be made to delete this data where practical while still allowing the plugin to be used by other users."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/choice/classes/privacy/provider.php"',title:'"mod/choice/classes/privacy/provider.php"'},"public static function delete_data_for_user(approved_contextlist $contextlist) {\n    global $DB;\n\n    if (empty($contextlist->count())) {\n        return;\n    }\n    $userid = $contextlist->get_user()->id;\n    foreach ($contextlist->get_contexts() as $context) {\n        $instanceid = $DB->get_field('course_modules', 'instance', ['id' => $context->instanceid], MUST_EXIST);\n        $DB->delete_records('choice_answers', ['choiceid' => $instanceid, 'userid' => $userid]);\n    }\n}\n")),(0,s.kt)("h4",{id:"delete-personal-information-for-several-users-in-a-specific-context"},"Delete personal information for several users in a specific context"),(0,s.kt)("p",null,"An ",(0,s.kt)("em",{parentName:"p"},"approved_userlist")," is given and user data related to all users in the specified context should either be completely deleted, or overwritten if a structure needs to be maintained. This will be called when a user has requested the right to be forgotten when per-role overrides exist, or when performing a per-role expiry of a context. All attempts should be made to delete this data where practical while still allowing the plugin to be used by other users."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/chat/classes/privacy/provider.php"',title:'"mod/chat/classes/privacy/provider.php"'},"/**\n * Delete multiple users within a single context.\n *\n * @param approved_userlist $userlist The approved context and user information to delete information for.\n */\npublic static function delete_data_for_users(approved_userlist $userlist) {\n    global $DB;\n\n    $context = $userlist->get_context();\n    $cm = $DB->get_record('course_modules', ['id' => $context->instanceid]);\n    $chat = $DB->get_record('chat', ['id' => $cm->instance]);\n\n    list($userinsql, $userinparams) = $DB->get_in_or_equal($userlist->get_userids(), SQL_PARAMS_NAMED);\n    $params = array_merge(['chatid' => $chat->id], $userinparams);\n    $sql = \"chatid = :chatid AND userid {$userinsql}\";\n\n    $DB->delete_records_select('chat_messages', $sql, $params);\n    $DB->delete_records_select('chat_messages_current', $sql, $params);\n    $DB->delete_records_select('chat_users', $sql, $params);\n}\n")),(0,s.kt)("h2",{id:"difference-between-moodle-33-and-more-recent-versions"},"Difference between Moodle 3.3 and more recent versions"),(0,s.kt)("p",null,"Moodle 3.3 has a minimum requirement of php 5.6 and so type hinting and return type declarations are not supported in this version.\nConsequently the privacy API for this version does not have these features."),(0,s.kt)("h2",{id:"common-questions"},"Common Questions"),(0,s.kt)("h3",{id:"what-to-do-if-you-have-one-plugin-that-supports-multiple-branches"},"What to do if you have one plugin that supports multiple branches"),(0,s.kt)("p",null,"This is something that we have considered and we have put in place a polyfill. This gets around the restrictions of one version having type hinting and return type declarations while another does not."),(0,s.kt)("h4",{id:"example-8"},"Example"),(0,s.kt)("p",null,"To use the polyfill include the legacy polyfill trait and create the necessary static methods but with an underscore (shown below)."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php"},"class provider implements\n    \\core_privacy\\local\\metadata\\provider,\n    \\core_privacy\\local\\request\\plugin\\provider {\n\n    // This trait must be included.\n    use \\core_privacy\\local\\legacy_polyfill;\n\n    // The required methods must be in this format starting with an underscore.\n    public static function _get_metadata(collection $collection) {\n        // Code for returning metadata goes here.\n    }\n")),(0,s.kt)("h3",{id:"what-to-do-if-your-plugin-must-implement-a-subplugin-or-subsystem-plugin-provider"},"What to do if your plugin must implement a subplugin or subsystem plugin provider"),(0,s.kt)("p",null,"For subplugins (e.g. assignsubmission, assignfeedback, quiz report, quiz access rules), or subsystems which have a plugintype relationship (portfolio, plagiarism, and others), they will also define their own legacy polyfill."),(0,s.kt)("p",null,"In this instance you will need to include the trait for both the core polyfill, and the provider polyfill as appropriate."),(0,s.kt)("h4",{id:"example-9"},"Example"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php"},"class provider implements\n    // This plugin has data and must therefore define the metadata provider in order to describe it.\n    \\core_privacy\\local\\metadata\\provider,\n\n    // This is a plagiarism plugin. It interacts with the plagiarism subsystem rather than with core.\n    \\core_plagiarism\\privacy\\plagiarism_provider {\n\n    // This trait must be included to provide the relevant polyfill for the metadata provider.\n    use \\core_privacy\\local\\legacy_polyfill;\n\n    // This trait must be included to provide the relevant polyfill for the plagirism provider.\n    use \\core_plagiarism\\privacy\\plagiarism_provider\\legacy_polyfill;\n\n    // The required methods must be in this format starting with an underscore.\n    public static function _get_metadata(collection $collection) {\n        // Code for returning metadata goes here.\n    }\n\n    // This is one of the polyfilled methods from the plagiarism provider.\n    public static function _export_plagiarism_user_data($userid, \\context $context, array $subcontext, array $linkarray) {\n        // ...\n    }\n")),(0,s.kt)("h3",{id:"what-to-do-with-missing-userlist-interfaces-in-legacy-versions"},"What to do with missing userlist interfaces in legacy versions"),(0,s.kt)("p",null,"Interface core_userlist_provider does not exists is releases of Moodle pre 3.5.3, pre 3.4.6 and 3.3.*. If you want one plugin branch to support multiple Moodle branches, try next solution (proposed in ",(0,s.kt)("a",{parentName:"p",href:"https://moodle.org/mod/forum/discuss.php?d=379580#p1530295"},"https://moodle.org/mod/forum/discuss.php?d=379580#p1530295"),")"),(0,s.kt)("h4",{id:"example-10"},"Example"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-php"},"namespace plugin_example\\privacy;\n\nif (interface_exists('\\core_privacy\\local\\request\\core_userlist_provider')) {\n    // Name can be same, as it is in other namespace\n    interface core_userlist_provider extends \\core_privacy\\local\\request\\core_userlist_provider {}\n} else {\n    interface core_userlist_provider {}\n}\n\nclass provider implements core_userlist_provider {\n")),(0,s.kt)("h2",{id:"tips-for-development"},"Tips for development"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"While implementing the privacy API into your plugin, there are CLI scripts that can help you to test things on the fly. Just don't forget these are not supposed to replace proper unit tests. See ",(0,s.kt)("a",{parentName:"li",href:"/devdocs/docs/apis/subsystems/privacy/utils"},"Privacy API/Utilities")," for details."),(0,s.kt)("li",{parentName:"ul"},"Inherit Unit tests from the ",(0,s.kt)("inlineCode",{parentName:"li"},'core_privacy\\tests\\provider_testcase</syntaxhighlight>, not <syntaxhighlight lang="php">advanced_testcase'),". Advanced test case doesn't reset the Privacy content_writer between tests!")),(0,s.kt)("h2",{id:"see-also"},"See also"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"/devdocs/docs/apis/subsystems/privacy/faq"},"Subject Access Request FAQ")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://docs.moodle.org/en/GDPR"},"GDPR")," in the user documentation"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"/devdocs/docs/apis/subsystems/privacy/utils"},"Privacy API/Utilities")," provides CLI scripts that are helpful during development")))}m.isMDXComponent=!0},685:function(e,t,n){t.Z=n.p+"assets/images/MoodlePrivacyMetadataUML-baec105888dc9fc6322f7a0776a5b94b.png"},88416:function(e,t,n){t.Z=n.p+"assets/images/MoodlePrivacyRequestUML-fec859e82cb116317473eea1279b9fe9.png"}}]);